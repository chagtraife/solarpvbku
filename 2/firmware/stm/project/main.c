#include "stm32f10x.h"
#include <string.h>
#include "stdio.h"
#include <math.h>
#include <stdlib.h>
#include "stm32f10x_usart.h"
#include "display.h"
#include "measure.h"



#define SLAVE_ID  01
//#define TEST
#define MEA_STATE    3
#define RECV_STATE   2
#define TRANS_STATE  1
#define IDLE_STATE   0


#ifdef __GNUC__
  /* With GCC/RAISONANCE, small printf (option LD Linker->Libraries->Small printf
     set to 'Yes') calls __io_putchar() */
  #define PUTCHAR_PROTOTYPE int __io_putchar(int ch)
#else
#define PUTCHAR_PROTOTYPE int fputc(int ch, FILE *f)
#define GETCHAR_PROTOTYPE int fgetc(FILE *f)
#endif /* __GNUC__ */
	
PUTCHAR_PROTOTYPE
{
	/* Place your implementation of fputc here */
	USART_SendData(USART1,(u8)ch);
	/*Loop until the end of transmission */
	while (USART_GetFlagStatus(USART1,USART_FLAG_TC)==RESET)
	{}

  	return ch;
}


/*Khoi tao bien cau hinh*/
//GPIO_InitTypeDef			GPIO_InitStructure;
NVIC_InitTypeDef 			NVIC_InitStructure;
USART_InitTypeDef			UART_InitStructure;
//I2C_InitTypeDef				I2C_InitStructure;
TIM_TimeBaseInitTypeDef TIM_InitStructure;


//uint8_t data =10;
extern int r;
extern ct ct1,ct2;
extern vt vtac;
extern p p1,p2;



#ifdef TEST
	int uadc_2[500] = {2048,	2072,	2097,	2121,	2145,	2169,	2194,	2218,	2242,	2266,	2290,	2314,	2338,	2362,	2386,	2410,	2434,	2458,	2481,	2505,	2529,	2552,	2576,	2599,	2622,	2645,	2668,	2691,	2714,	2737,	2759,	2782,	2804,	2827,	2849,	2871,	2893,	2915,	2936,	2958,	2979,	3000,	3021,	3042,	3063,	3083,	3104,	3124,	3144,	3164,	3184,	3203,	3223,	3242,	3261,	3280,	3298,	3317,	3335,	3353,	3371,	3388,	3406,	3423,	3440,	3456,	3473,	3489,	3505,	3521,	3536,	3552,	3567,	3582,	3596,	3611,	3625,	3639,	3652,	3666,	3679,	3692,	3704,	3717,	3729,	3740,	3752,	3763,	3774,	3785,	3795,	3805,	3815,	3825,	3834,	3843,	3852,	3860,	3869,	3876,	3884,	3891,	3898,	3905,	3912,	3918,	3923,	3929,	3934,	3939,	3944,	3948,	3952,	3956,	3959,	3962,	3965,	3968,	3970,	3972,	3974,	3975,	3976,	3977,	3977,	3977,	3977,	3976,	3975,	3974,	3973,	3971,	3969,	3967,	3964,	3961,	3958,	3954,	3950,	3946,	3942,	3937,	3932,	3926,	3921,	3915,	3908,	3902,	3895,	3888,	3880,	3873,	3865,	3856,	3848,	3839,	3830,	3820,	3810,	3800,	3790,	3780,	3769,	3758,	3746,	3735,	3723,	3710,	3698,	3685,	3672,	3659,	3646,	3632,	3618,	3604,	3589,	3574,	3559,	3544,	3529,	3513,	3497,	3481,	3465,	3448,	3431,	3414,	3397,	3379,	3362,	3344,	3326,	3307,	3289,	3270,	3251,	3232,	3213,	3194,	3174,	3154,	3134,	3114,	3094,	3073,	3053,	3032,	3011,	2990,	2968,	2947,	2925,	2904,	2882,	2860,	2838,	2816,	2793,	2771,	2748,	2725,	2703,	2680,	2657,	2634,	2610,	2587,	2564,	2540,	2517,	2493,	2470,	2446,	2422,	2398,	2374,	2350,	2326,	2302,	2278,	2254,	2230,	2206,	2181,	2157,	2133,	2109,	2084,	2060,	2036,	2012,	1987,	1963,	1939,	1915,	1890,	1866,	1842,	1818,	1794,	1770,	1746,	1722,	1698,	1674,	1650,	1626,	1603,	1579,	1556,	1532,	1509,	1486,	1462,	1439,	1416,	1393,	1371,	1348,	1325,	1303,	1280,	1258,	1236,	1214,	1192,	1171,	1149,	1128,	1106,	1085,	1064,	1043,	1023,	1002,	982,	962,	942,	922,	902,	883,	864,	845,	826,	807,	789,	770,	752,	734,	717,	699,	682,	665,	648,	631,	615,	599,	583,	567,	552,	537,	522,	507,	492,	478,	464,	450,	437,	424,	411,	398,	386,	373,	361,	350,	338,	327,	316,	306,	296,	286,	276,	266,	257,	248,	240,	231,	223,	216,	208,	201,	194,	188,	181,	175,	170,	164,	159,	154,	150,	146,	142,	138,	135,	132,	129,	127,	125,	123,	122,	121,	120,	119,	119,	119,	119,	120,	121,	122,	124,	126,	128,	131,	134,	137,	140,	144,	148,	152,	157,	162,	167,	173,	178,	184,	191,	198,	205,	212,	220,	227,	236,	244,	253,	262,	271,	281,	291,	301,	311,	322,	333,	344,	356,	367,	379,	392,	404,	417,	430,	444,	457,	471,	485,	500,	514,	529,	544,	560,	575,	591,	607,	623,	640,	656,	673,	690,	708,	725,	743,	761,	779,	798,	816,	835,	854,	873,	893,	912,	932,	952,	972,	992,	1013,	1033,	1054,	1075,	1096,	1117,	1138,	1160,	1181,	1203,	1225,	1247,	1269,	1292,	1314,	1337,	1359,	1382,	1405,	1428,	1451,	1474,	1497,	1520,	1544,	1567,	1591,	1615,	1638,	1662,	1686,	1710,	1734,	1758,	1782,	1806,	1830,	1854,	1878,	1902,	1927,	1951,	1975,	1999,	2024,	2048};
  int iadc_1[500] = {2048,	2072,	2097,	2121,	2145,	2169,	2194,	2218,	2242,	2266,	2290,	2314,	2338,	2362,	2386,	2410,	2434,	2458,	2481,	2505,	2529,	2552,	2576,	2599,	2622,	2645,	2668,	2691,	2714,	2737,	2759,	2782,	2804,	2827,	2849,	2871,	2893,	2915,	2936,	2958,	2979,	3000,	3021,	3042,	3063,	3083,	3104,	3124,	3144,	3164,	3184,	3203,	3223,	3242,	3261,	3280,	3298,	3317,	3335,	3353,	3371,	3388,	3406,	3423,	3440,	3456,	3473,	3489,	3505,	3521,	3536,	3552,	3567,	3582,	3596,	3611,	3625,	3639,	3652,	3666,	3679,	3692,	3704,	3717,	3729,	3740,	3752,	3763,	3774,	3785,	3795,	3805,	3815,	3825,	3834,	3843,	3852,	3860,	3869,	3876,	3884,	3891,	3898,	3905,	3912,	3918,	3923,	3929,	3934,	3939,	3944,	3948,	3952,	3956,	3959,	3962,	3965,	3968,	3970,	3972,	3974,	3975,	3976,	3977,	3977,	3977,	3977,	3976,	3975,	3974,	3973,	3971,	3969,	3967,	3964,	3961,	3958,	3954,	3950,	3946,	3942,	3937,	3932,	3926,	3921,	3915,	3908,	3902,	3895,	3888,	3880,	3873,	3865,	3856,	3848,	3839,	3830,	3820,	3810,	3800,	3790,	3780,	3769,	3758,	3746,	3735,	3723,	3710,	3698,	3685,	3672,	3659,	3646,	3632,	3618,	3604,	3589,	3574,	3559,	3544,	3529,	3513,	3497,	3481,	3465,	3448,	3431,	3414,	3397,	3379,	3362,	3344,	3326,	3307,	3289,	3270,	3251,	3232,	3213,	3194,	3174,	3154,	3134,	3114,	3094,	3073,	3053,	3032,	3011,	2990,	2968,	2947,	2925,	2904,	2882,	2860,	2838,	2816,	2793,	2771,	2748,	2725,	2703,	2680,	2657,	2634,	2610,	2587,	2564,	2540,	2517,	2493,	2470,	2446,	2422,	2398,	2374,	2350,	2326,	2302,	2278,	2254,	2230,	2206,	2181,	2157,	2133,	2109,	2084,	2060,	2036,	2012,	1987,	1963,	1939,	1915,	1890,	1866,	1842,	1818,	1794,	1770,	1746,	1722,	1698,	1674,	1650,	1626,	1603,	1579,	1556,	1532,	1509,	1486,	1462,	1439,	1416,	1393,	1371,	1348,	1325,	1303,	1280,	1258,	1236,	1214,	1192,	1171,	1149,	1128,	1106,	1085,	1064,	1043,	1023,	1002,	982,	962,	942,	922,	902,	883,	864,	845,	826,	807,	789,	770,	752,	734,	717,	699,	682,	665,	648,	631,	615,	599,	583,	567,	552,	537,	522,	507,	492,	478,	464,	450,	437,	424,	411,	398,	386,	373,	361,	350,	338,	327,	316,	306,	296,	286,	276,	266,	257,	248,	240,	231,	223,	216,	208,	201,	194,	188,	181,	175,	170,	164,	159,	154,	150,	146,	142,	138,	135,	132,	129,	127,	125,	123,	122,	121,	120,	119,	119,	119,	119,	120,	121,	122,	124,	126,	128,	131,	134,	137,	140,	144,	148,	152,	157,	162,	167,	173,	178,	184,	191,	198,	205,	212,	220,	227,	236,	244,	253,	262,	271,	281,	291,	301,	311,	322,	333,	344,	356,	367,	379,	392,	404,	417,	430,	444,	457,	471,	485,	500,	514,	529,	544,	560,	575,	591,	607,	623,	640,	656,	673,	690,	708,	725,	743,	761,	779,	798,	816,	835,	854,	873,	893,	912,	932,	952,	972,	992,	1013,	1033,	1054,	1075,	1096,	1117,	1138,	1160,	1181,	1203,	1225,	1247,	1269,	1292,	1314,	1337,	1359,	1382,	1405,	1428,	1451,	1474,	1497,	1520,	1544,	1567,	1591,	1615,	1638,	1662,	1686,	1710,	1734,	1758,	1782,	1806,	1830,	1854,	1878,	1902,	1927,	1951,	1975,	1999,	2024,	2048};
	int iadc_2[500] = {2048,	2064,	2080,	2097,	2113,	2129,	2145,	2161,	2177,	2193,	2209,	2226,	2242,	2258,	2274,	2289,	2305,	2321,	2337,	2353,	2368,	2384,	2400,	2415,	2431,	2446,	2462,	2477,	2492,	2507,	2522,	2537,	2552,	2567,	2582,	2597,	2611,	2626,	2640,	2654,	2669,	2683,	2697,	2711,	2725,	2738,	2752,	2765,	2779,	2792,	2805,	2818,	2831,	2844,	2857,	2869,	2881,	2894,	2906,	2918,	2930,	2941,	2953,	2964,	2976,	2987,	2998,	3009,	3019,	3030,	3040,	3051,	3061,	3071,	3080,	3090,	3099,	3108,	3118,	3126,	3135,	3144,	3152,	3160,	3168,	3176,	3184,	3191,	3199,	3206,	3213,	3220,	3226,	3233,	3239,	3245,	3251,	3256,	3262,	3267,	3272,	3277,	3282,	3286,	3290,	3294,	3298,	3302,	3305,	3309,	3312,	3315,	3317,	3320,	3322,	3324,	3326,	3328,	3329,	3331,	3332,	3333,	3333,	3334,	3334,	3334,	3334,	3333,	3333,	3332,	3331,	3330,	3329,	3327,	3325,	3323,	3321,	3319,	3316,	3313,	3310,	3307,	3304,	3300,	3296,	3292,	3288,	3284,	3279,	3275,	3270,	3264,	3259,	3253,	3248,	3242,	3236,	3229,	3223,	3216,	3209,	3202,	3195,	3188,	3180,	3172,	3164,	3156,	3148,	3139,	3131,	3122,	3113,	3104,	3095,	3085,	3075,	3066,	3056,	3045,	3035,	3025,	3014,	3003,	2992,	2981,	2970,	2959,	2947,	2936,	2924,	2912,	2900,	2888,	2875,	2863,	2850,	2838,	2825,	2812,	2799,	2785,	2772,	2759,	2745,	2731,	2718,	2704,	2690,	2676,	2662,	2647,	2633,	2618,	2604,	2589,	2575,	2560,	2545,	2530,	2515,	2500,	2484,	2469,	2454,	2438,	2423,	2407,	2392,	2376,	2361,	2345,	2329,	2313,	2297,	2281,	2266,	2250,	2234,	2218,	2201,	2185,	2169,	2153,	2137,	2121,	2105,	2088,	2072,	2056,	2040,	2024,	2008,	1991,	1975,	1959,	1943,	1927,	1911,	1895,	1878,	1862,	1846,	1830,	1815,	1799,	1783,	1767,	1751,	1735,	1720,	1704,	1689,	1673,	1658,	1642,	1627,	1612,	1596,	1581,	1566,	1551,	1536,	1521,	1507,	1492,	1478,	1463,	1449,	1434,	1420,	1406,	1392,	1378,	1365,	1351,	1337,	1324,	1311,	1297,	1284,	1271,	1258,	1246,	1233,	1221,	1208,	1196,	1184,	1172,	1160,	1149,	1137,	1126,	1115,	1104,	1093,	1082,	1071,	1061,	1051,	1040,	1030,	1021,	1011,	1001,	992,	983,	974,	965,	957,	948,	940,	932,	924,	916,	908,	901,	894,	887,	880,	873,	867,	860,	854,	848,	843,	837,	832,	826,	821,	817,	812,	808,	804,	800,	796,	792,	789,	786,	783,	780,	777,	775,	773,	771,	769,	767,	766,	765,	764,	763,	763,	762,	762,	762,	762,	763,	763,	764,	765,	767,	768,	770,	772,	774,	776,	779,	781,	784,	787,	791,	794,	798,	802,	806,	810,	814,	819,	824,	829,	834,	840,	845,	851,	857,	863,	870,	876,	883,	890,	897,	905,	912,	920,	928,	936,	944,	952,	961,	970,	978,	988,	997,	1006,	1016,	1025,	1035,	1045,	1056,	1066,	1077,	1087,	1098,	1109,	1120,	1132,	1143,	1155,	1166,	1178,	1190,	1202,	1215,	1227,	1239,	1252,	1265,	1278,	1291,	1304,	1317,	1331,	1344,	1358,	1371,	1385,	1399,	1413,	1427,	1442,	1456,	1470,	1485,	1499,	1514,	1529,	1544,	1559,	1574,	1589,	1604,	1619,	1634,	1650,	1665,	1681,	1696,	1712,	1728,	1743,	1759,	1775,	1791,	1807,	1822,	1838,	1854,	1870,	1887,	1903,	1919,	1935,	1951,	1967,	1983,	1999,	2016,	2032,	2048};	
	//r1(iadc_1) =10 ohm
	//r2(iadc_2) =15 ohm
#else
  //int iadc_1[500],iadc_2[500],uadc_2[500];		
#endif

float I1, I2,U2 ,f, P1, P2, PF;
volatile extern char state;
volatile extern char cmd_buf[8];


void GPIO_Configuration(void);
void Delay_ms(uint16_t time);
void Delay_us(uint16_t time);

void UART_Configuration (void);
void I2C_Configuration(void);


int main(void)
{
	int counter = 0 ;

	GPIO_Configuration();
	UART_Configuration();//uart_debug+ uart to ras
	//I2C_Configuration();
	measure_init();
	display_init();
	//TIM4_Configuration();
	state  = MEA_STATE;
	r=0;// l: la so lan MEAS trong khoang thoi gian request cua esp
	display();
  while (1)
  {	
		switch(state)
			{
			case IDLE_STATE:
				{
					//PWR_WakeUpPinCmd(ENABLE);
					//PWR_DeInit();
          //PWR_EnterSTANDBYMode();
					//state = MEA_STATE;
					break;
					}
			case TRANS_STATE: 
				{
					send_data();
					r = 0;
					state = MEA_STATE;
					break;
					}
			case RECV_STATE:
				{
			//		process_cmd();
					break;
					}
			case MEA_STATE:
				{
					counter++;
					measure_data_AC(); // mesure data trong 1 chu ki dien
					avr_data();
					if(counter >50)
						{ display();
							counter = 0;
							}
					break;
					}
			}
					//send data to ras	
			//	Delay_ms(1000);
					
  }
}
void GPIO_Configuration(void)
{
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE);
	
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_9 ;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;
	GPIO_Init(GPIOB, &GPIO_InitStructure);
}
void Delay_ms(uint16_t time)
{
uint32_t time_n=time*12000;
	while(time_n!=0){time_n--;}
}

void Delay_us(uint16_t time)
 {
uint32_t time_n=time*12;
	while(time_n!=0){time_n--;}
}
 

void UART_Configuration (void)
	{
		/*Cap clock cho USART và port su dung*/
			RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);
			RCC_APB2PeriphClockCmd(RCC_APB2Periph_USART1, ENABLE);
		
			/* Cau Tx mode AF_PP, Rx mode FLOATING  */
			GPIO_InitStructure.GPIO_Pin = GPIO_Pin_9;//TX
			GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;
			GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
			GPIO_Init(GPIOA, &GPIO_InitStructure);
		
			GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10;//RX
			GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;
			GPIO_Init(GPIOA, &GPIO_InitStructure);	
		
		
		NVIC_PriorityGroupConfig(NVIC_PriorityGroup_1);
    /* Enable the USARTy Interrupt */
    NVIC_InitStructure.NVIC_IRQChannel = USART1_IRQn;
    NVIC_InitStructure.NVIC_IRQChannelSubPriority = 2;
    NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
    NVIC_Init(&NVIC_InitStructure);
		
		/*Cau hinh USART*/
			UART_InitStructure.USART_BaudRate = 9600;
			UART_InitStructure.USART_WordLength = USART_WordLength_8b;
			UART_InitStructure.USART_StopBits = USART_StopBits_1;
			UART_InitStructure.USART_Parity = USART_Parity_No;
			UART_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None;
			UART_InitStructure.USART_Mode = USART_Mode_Rx | USART_Mode_Tx;
			USART_Init(USART1, &UART_InitStructure);
				
			/* Cho phep UART hoat dong */
			USART_Cmd(USART1, ENABLE);
	    USART_ITConfig(USART1, USART_IT_RXNE, ENABLE); //cho phep ngat nhan 
      //USART_ITConfig(USART1, USART_IT_TXE, ENABLE); // cho phep ngat truyen
	}
	
void I2C_Configuration(void)
	{
		I2C_InitTypeDef				I2C_InitStructure;
		/*Cap clock cho I2C và port su dung*/
		RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE);
		RCC_APB1PeriphClockCmd(RCC_APB1Periph_I2C2, ENABLE);
		
		
		/* Cau hinh chan SDA, SCL   */
		GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10 | GPIO_Pin_11;//PB10:SCL           PB11:SDA
		GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_OD;
		GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
		GPIO_Init(GPIOB, &GPIO_InitStructure);

		/* cau hinh i2c*/
			I2C_InitStructure.I2C_Mode = I2C_Mode_I2C;
		I2C_InitStructure.I2C_DutyCycle = I2C_DutyCycle_2;
		I2C_InitStructure.I2C_OwnAddress1 = 0;
		I2C_InitStructure.I2C_Ack = I2C_Ack_Disable;
		I2C_InitStructure.I2C_AcknowledgedAddress = I2C_AcknowledgedAddress_7bit;
		I2C_InitStructure.I2C_ClockSpeed = 100000;
		I2C_Init(I2C2,&I2C_InitStructure);
		
		I2C_Cmd(I2C2,ENABLE);
		}
